name: Auto-Improve Repository

on:
  # Run daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'

  # Allow manual trigger
  workflow_dispatch:

  # Run on push to main branch (but skip if commit is from the bot)
  push:
    branches:
      - main

jobs:
  auto-improve:
    runs-on: ubuntu-latest

    # Skip if the last commit was from the auto-improve bot
    if: "!contains(github.event.head_commit.message, 'ðŸ¤– Auto-improve:')"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js (if package.json exists)
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies (if package.json exists)
        if: hashFiles('package.json') != ''
        run: npm ci || npm install

      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Configure Git for bot commits
        run: |
          git config --global user.name "BREZ Auto-Improve Bot"
          git config --global user.email "bot@brez.com"

      - name: Run auto-improve script
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AGENT_SERVER_URL: https://api.anthropic.com/v1/messages
        run: |
          chmod +x ./auto-improve.sh
          ./auto-improve.sh --single-run

      - name: Push improvements if any
        run: |
          if ! git diff --quiet; then
            git push origin main
          else
            echo "No improvements to push"
          fi

      - name: Create issue for Tier 3 proposals (if any)
        if: hashFiles('.auto-improve-proposals.json') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('.auto-improve-proposals.json')) {
              const proposals = fs.readFileSync('.auto-improve-proposals.json', 'utf8');
              const lines = proposals.trim().split('\n');

              if (lines.length > 0) {
                const lastProposal = JSON.parse(lines[lines.length - 1]);

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸ¤– Auto-Improve Proposal: ${lastProposal.title}`,
                  body: `## Improvement Proposal (Tier 3 - Requires Human Review)

**Title:** ${lastProposal.title}

**Description:** ${lastProposal.description}

**Expected Benefit:** ${lastProposal.expected_benefit}

**Risk Level:** ${lastProposal.risk_level}

**Proposed Commands:**
\`\`\`bash
${lastProposal.commands?.join('\n') || 'See file modifications below'}
\`\`\`

**Files to Modify:**
${lastProposal.files_to_modify?.map(f => `- \`${f.path}\`: ${f.change}`).join('\n') || 'None'}

---
*This proposal was generated by the BREZ Auto-Improve system.*
*Review and implement manually if approved.*`,
                  labels: ['auto-improve', 'tier-3', 'needs-review']
                });
              }
            }
